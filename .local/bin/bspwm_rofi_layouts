#!/usr/bin/env bash

# https://fontawesome.com/v5.15/icons?d=gallery&p=2
if test "${1}" = "query"; then
  did="$(bspc query -D -n focused --names)"
  layout="$(bsp-layout get ${did})"

  clayout="$(bspc query -T -d | jq --raw-output '.layout')"
  test "${layout}" = "-" -o "${clayout}" = "monocle" && layout="${clayout}"

  case "${layout}" in
    tall)       printf -- '[]='  ;;
    rtall)      printf -- '=[]'  ;;
    wide)       printf -- 'TTT'  ;;
    rwide)      printf -- 'LLL'  ;;
    tile|tiled) printf -- '[]-'  ;;
    grid)       printf -- '|-|-|';;
    rgrid)      printf -- '-|-|-';;
    even)       printf -- '[][]' ;;
    monocle)    printf -- '[M]'  ;;
    -|*)        printf -- '[?]'  ;;
  esac
  exit 0
fi

set +o errexit
read -r -d '' layouts <<'EOLAYOUTS'
tall
taller
rtall
rtaller
wide
rwide
monocle
tiled
grid
rgrid
even
EOLAYOUTS
set -o errexit

lines=$(($(printf "${layouts}" | wc -l) + 1))
clayout="$(bspwm_active_layout 2>/dev/null || bspc query -T -d | jq --raw-output '.layout')"

layout="$(printf "${layouts}" | rofi -lines "${lines}" -dmenu -p "${clayout}")"

did="$(bspc query -D -n focused --names)"
case "${layout}" in
  rtall) ms="0.62";;
  taller) ms="0.42"; layout=tall;;
  rtaller) ms="0.42"; layout=tall;;
  *) ms="0.55";;
esac
case "${layout}" in
  tall|rtall|wide|rwide|taller|rtaller) bsp-layout set "${layout}" "${did}" --master-size "${ms}";;
  grid|rgrid|even) bsp-layout set "${layout}" "${did}";;
  tiled|monocle) bsp-layout remove "${did}"; bspc desktop --layout "${layout}"; bsp-layout once "${layout}";;
  *);;
esac

#layout="$(bsp-layout get ${did})"
#test "${layout}" = "-" -o "${layout}" = "tile" \
#  && bsp-layout set tall "${did}" --master-size 0.55 \
#  || {bsp-layout remove "${did}"; bsp-layout once tile}
