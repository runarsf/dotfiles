#!/bin/sh
# depends on wmutils/opt
#  pacman -S base-devel
#  yay -S wmutils-git

border_color_in_normal="585A5D"
border_color_out_normal="000000"
border_color_in_focused="${border_color_in_normal}"
border_color_out_focused="${border_color_out_normal}"
#border_color_in_focused="5d637a"
#border_color_out_focused="30333d"

bspwindows () {
  kind="${1:-active}"
  test "${#}" -gt "0" && shift

  case "${kind}" in
    active)
      bspc query -N -n ".local.descendant_of.window.leaf.!fullscreen.!hidden${*}";;
    inactive)
      bspc query -N -n ".local.!descendant_of.window.leaf.!fullscreen.!hidden${*}";;
    visible)
      bspc query -N -n ".local.!descendant_of.window.leaf.!fullscreen.!hidden${*}"
      bspc query -N -n ".local.descendant_of.window.leaf.!fullscreen.!hidden${*}";;
  esac
}

bspc config border_width 3
border_width_current="$(bspc config border_width)"

# half if even, 1px to outer if odd
border_width_in_normal="2"
border_width_out_normal="1"
border_width_in_focused="${border_width_in_normal}"
border_width_out_focused="${border_width_out_normal}"
#border_width_in_normal="$(( (border_width_current/2) - 2 ))"
#border_width_out_normal="$(( (border_width_current/2) + (border_width_current%2) + 2 ))"
#border_width_in_focused="${border_width_in_normal}"
#border_width_out_focused="${border_width_out_normal}"

#set_default_borders
bspc config normal_border_color "#${border_color_in_normal}"
bspc config active_border_color "#${border_color_in_normal}"
bspc config focused_border_color "#${border_color_in_normal}"

width_normal="$((border_width_in_normal+border_width_out_normal))"
width_focused="$((border_width_in_focused+border_width_out_focused))"
bspc config border_width "${width_normal}"

_chwb2() {
  colorType=$1
  shift

  _getVal() {
    eval echo \$${1}_${colorType}
  }

  test "${width_normal}" = "${width_focused}" \
  || echo "${@}" | sed 's/ /\n/g' | xargs -I{} bspc config -n {} border_width "$(_getVal width)"

  # -O '0xff123456' \
  # chwb2 -I 292b34 -O 30333d -i 3 -o 7 0xffA00001 2>/dev/null
  # ROBIN: Prøvd å sleng 0xff foran -I og -O
  chwb2 \
    -I "$(_getVal border_color_in)" \
    -O "$(_getVal border_color_out)" \
    -i "$(_getVal border_width_in)" \
    -o "$(_getVal border_width_out)" "${@}" 2>/dev/null
}

_chwb2 focused "$(bspwindows)"
_chwb2 normal "$(bspwindows inactive)"

bspc subscribe node_state node_geometry node_focus \
  | while read msg; do
      _chwb2 focused $(bspwindows)
      _chwb2 normal $(bspwindows inactive)
    done
