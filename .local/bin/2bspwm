#!/bin/sh
# depends on wmutils/opt
#  pacman -S base-devel
#  yay -S wmutils-git
# https://github.com/virginfuhrer/dots/blob/master/.local/bin/2bspwm

border_color_in_normal="292b34"
border_color_out_normal="30333d"
border_color_in_focused="5d637a"
border_color_out_focused="30333d"

function set_default_borders {
  bspc config normal_border_color "#2e2e2e"
  bspc config active_border_color "#2e2e2e"
  bspc config focused_border_color "#306998"
  bspc config presel_feedback_color "#5e81ac"
  bspc config urgent_border_color "#dd2727"

  bspc config border_width "3"
  #bspc config normal_border_color "#${border_color_out_normal}"
  #bspc config active_border_color "#${border_color_out_normal}"
  #bspc config focused_border_color "#${border_color_out_normal}"
}
trap set_default_borders EXIT

bspwindows () {
  kind="${1:-active}"
  test "${#}" -gt "0" && shift

  case "${kind}" in
    active)
      #bspc query -N -n .local.descendant_of.window.leaf.!fullscreen
      bspc query -N -n ".local.descendant_of.window.leaf.!fullscreen.!hidden${*}";;
    inactive)
      #bspc query -N -n .local.!descendant_of.window.leaf.!fullscreen
      bspc query -N -n ".local.!descendant_of.window.leaf.!fullscreen.!hidden${*}";;
    visible)
      bspc query -N -n ".local.!descendant_of.window.leaf.!fullscreen.!hidden${*}"
      bspc query -N -n ".local.descendant_of.window.leaf.!fullscreen.!hidden${*}";;
  esac
}

bspc config border_width 10
border_width_current="$(bspc config border_width)"

# half if even, 1px to outer if odd
# TODO: Fix ' - 2'
border_width_in_normal="$(( (border_width_current/2) - 2 ))"
border_width_out_normal="$(( (border_width_current/2) + (border_width_current%2) + 2 ))"
border_width_in_focused="${border_width_in_normal}"
border_width_out_focused="${border_width_out_normal}"

#set_default_borders
bspc config normal_border_color "#${border_color_out_normal}"
bspc config active_border_color "#${border_color_out_normal}"
bspc config focused_border_color "#${border_color_out_normal}"

_chwb2() {
  colorType=$1
  shift

  _getVal() {
    eval echo \$${1}_${colorType}
  }

  test "${width_normal}" = "${width_focused}" \
  || echo "${@}" | sed 's/ /\n/g' | xargs -I{} bspc config -n {} border_width "$(_getVal width)"

  # -O '0xff123456' \
  # chwb2 -I 292b34 -O 30333d -i 3 -o 7 0xffA00001 2>/dev/null
  # ROBIN: Prøvd å sleng 0xff foran -I og -O
  chwb2 \
    -I "$(_getVal border_color_in)" \
    -O "$(_getVal border_color_out)" \
    -i "$(_getVal border_width_in)" \
    -o "$(_getVal border_width_out)" "${@}" 2>/dev/null
}

width_normal="$((border_width_in_normal+border_width_out_normal))"
width_focused="$((border_width_in_focused+border_width_out_focused))"
bspc config border_width "${width_normal}"

_chwb2 focused "$(bspwindows)"
_chwb2 normal "$(bspwindows inactive)"

bspc subscribe node_state node_geometry node_focus \
  | while read msg; do
      _chwb2 focused $(bspwindows)
      _chwb2 normal $(bspwindows inactive)
    done
